---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { verifyToken } from "../../../lib/server/auth";
import connectDB from "../../../lib/server/db";
import JobOffer from "../../../lib/server/models/JobOffer";

const { id } = Astro.params;
const token = Astro.cookies.get("admin_token")?.value;

if (!token || !verifyToken(token)) {
    return Astro.redirect("/admin/login");
}

await connectDB();
const offer = await JobOffer.findById(id);

if (!offer) {
    return Astro.redirect("/admin");
}

const requirementsString = offer.requirements.join("\n");
---

<AdminLayout title="Editar Oferta">
    <h1 class="text-3xl font-bold mb-8 text-white tracking-tight">
        Editar Oferta: <span class="text-action">{offer.title}</span>
    </h1>

    <form
        id="editOfferForm"
        data-id={offer._id}
        class="bg-neutral-900 shadow-xl rounded-3xl px-8 pt-8 pb-8 mb-4 border border-neutral-800"
    >
        <div class="mb-6">
            <label
                class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                for="title"
            >
                Título
            </label>
            <input
                class="shadow-sm appearance-none border border-neutral-700 rounded-xl w-full py-3 px-4 text-white bg-neutral-800 leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all placeholder-gray-500"
                id="title"
                name="title"
                type="text"
                value={offer.title}
                required
                minlength="3"
            />
        </div>

        <div class="mb-6">
            <label
                class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                for="description"
            >
                Descripción
            </label>
            <textarea
                class="shadow-sm appearance-none border border-neutral-700 rounded-xl w-full py-3 px-4 text-white bg-neutral-800 leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all placeholder-gray-500"
                id="description"
                name="description"
                rows="5"
                required
                minlength="10">{offer.description}</textarea
            >
        </div>

        <div class="mb-6">
            <label
                class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                for="requirements"
            >
                Requisitos (uno por línea)
            </label>
            <textarea
                class="shadow-sm appearance-none border border-neutral-700 rounded-xl w-full py-3 px-4 text-white bg-neutral-800 leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all placeholder-gray-500"
                id="requirements"
                name="requirements"
                rows="4">{requirementsString}</textarea
            >
        </div>

        <div class="flex flex-wrap -mx-3 mb-6">
            <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
                <label
                    class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                    for="location"
                >
                    Ubicación
                </label>
                <input
                    class="shadow-sm appearance-none border border-neutral-700 rounded-xl w-full py-3 px-4 text-white bg-neutral-800 leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all placeholder-gray-500"
                    id="location"
                    name="location"
                    type="text"
                    value={offer.location}
                />
            </div>
            <div class="w-full md:w-1/3 px-3 mb-6 md:mb-0">
                <label
                    class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                    for="salaryMin"
                >
                    Salario Mínimo (€)
                </label>
                <input
                    class="shadow-sm appearance-none border border-neutral-700 rounded-xl w-full py-3 px-4 text-white bg-neutral-800 leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all placeholder-gray-500"
                    id="salaryMin"
                    name="salaryMin"
                    type="number"
                    value={offer.salaryMin}
                />
            </div>
            <div class="w-full md:w-1/3 px-3">
                <label
                    class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                    for="salaryMax"
                >
                    Salario Máximo (€)
                </label>
                <input
                    class="shadow-sm appearance-none border border-neutral-700 rounded-xl w-full py-3 px-4 text-white bg-neutral-800 leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all placeholder-gray-500"
                    id="salaryMax"
                    name="salaryMax"
                    type="number"
                    value={offer.salaryMax}
                />
            </div>
        </div>

        <div class="flex flex-wrap -mx-3 mb-6">
            <div class="w-full md:w-1/2 px-3 mb-6 md:mb-0">
                <label
                    class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                    for="status"
                >
                    Estado
                </label>
                <div class="relative">
                    <select
                        class="block appearance-none w-full bg-neutral-800 border border-neutral-700 text-white py-3 px-4 pr-8 rounded-xl leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all"
                        id="status"
                        name="status"
                    >
                        <option
                            value="draft"
                            selected={offer.status === "draft"}>Borrador</option
                        >
                        <option
                            value="active"
                            selected={offer.status === "active"}>Activa</option
                        >
                        <option
                            value="closed"
                            selected={offer.status === "closed"}>Cerrada</option
                        >
                    </select>
                    <div
                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400"
                    >
                        <svg
                            class="fill-current h-4 w-4"
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 20 20"
                            ><path
                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                            ></path></svg
                        >
                    </div>
                </div>
            </div>
            <div class="w-full md:w-1/2 px-3">
                <label
                    class="block text-gray-400 text-sm font-bold mb-2 uppercase tracking-wider"
                    for="vacancies"
                >
                    Vacantes
                </label>
                <input
                    class="shadow-sm appearance-none border border-neutral-700 rounded-xl w-full py-3 px-4 text-white bg-neutral-800 leading-tight focus:outline-none focus:ring-2 focus:ring-action focus:border-transparent transition-all placeholder-gray-500"
                    id="vacancies"
                    name="vacancies"
                    type="number"
                    min="1"
                    value={offer.vacancies}
                />
            </div>
        </div>

        <div class="flex items-center justify-between mt-8">
            <button
                class="bg-action hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-action shadow-lg shadow-action/20 transition-all transform hover:scale-[1.02]"
                type="submit"
            >
                Actualizar Oferta
            </button>
            <a
                class="inline-block align-baseline font-bold text-sm text-gray-400 hover:text-white transition-colors"
                href="/admin"
            >
                Cancelar
            </a>
        </div>
    </form>
</AdminLayout>

<script>
    const form = document.getElementById("editOfferForm");

    if (form instanceof HTMLFormElement) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = form.dataset.id;
            const formData = new FormData(form);

            const reqVal = formData.get("requirements");
            const reqString = typeof reqVal === "string" ? reqVal : "";

            const requirements = reqString
                .split("\n")
                // @ts-ignore
                .filter((line) => line.trim() !== "");

            const vacVal = formData.get("vacancies");
            const vacancies = vacVal ? parseInt(String(vacVal)) : undefined;

            const minVal = formData.get("salaryMin");
            const maxVal = formData.get("salaryMax");
            const salaryMin = minVal ? parseFloat(String(minVal)) : undefined;
            const salaryMax = maxVal ? parseFloat(String(maxVal)) : undefined;

            const data = {
                title: formData.get("title"),
                description: formData.get("description"),
                requirements: requirements,
                location: formData.get("location"),
                salaryMin: salaryMin,
                salaryMax: salaryMax,
                status: formData.get("status"),
                vacancies: vacancies,
            };

            try {
                const res = await fetch(`/api/admin/job-offers/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (res.ok) {
                    window.location.href = "/admin";
                } else {
                    const error = await res.json();
                    alert("Error: " + error.error);
                }
            } catch (err) {
                alert("Error al actualizar");
            }
        });
    }
</script>
